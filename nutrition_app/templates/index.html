<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Health Mate - Tr·ª£ L√Ω S·ª©c Kh·ªèe</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
        .water-card { background: #f0f8ff; border: 2px solid #add8e6; border-radius: 20px; padding: 20px; margin-top: 20px; text-align: center; }
        .btn-water { background: #00a8ff; color: white; border: none; padding: 8px 15px; border-radius: 10px; margin: 5px; cursor: pointer; transition: 0.3s; font-weight: bold; }
        .btn-water:hover { background: #0086cc; transform: scale(1.05); }
        .progress-container { height: 25px; margin: 15px 0; background: #e0e0e0; border-radius: 12px; overflow: hidden; }
        .progress-bar-water { background: linear-gradient(90deg, #4facfe 0%, #00f2fe 100%); height: 100%; transition: 0.8s ease-out; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div style="font-size: 60px;">ü•ó</div>
    <h2 style="color: var(--primary-color);">ƒêang Thi·∫øt L·∫≠p L·ªô Tr√¨nh...</h2>
    <p>H·ªá th·ªëng ƒëang chu·∫©n b·ªã menu v√† b·ªô ƒë·∫øm n∆∞·ªõc cho b·∫°n!</p>
    <div class="loader" style="border-color: var(--primary-color); border-bottom-color: transparent; width: 50px; height: 50px;"></div>
</div>

<div class="container">
    {% if not user %}
        <div class="auth-box">
            <div style="font-size: 50px; margin-bottom: 10px;">ü•ë</div>
            <h1 style="color: var(--primary-color);">Health Mate</h1>
            <p style="color: #666; margin-bottom: 30px;">Ng∆∞·ªùi b·∫°n ƒë·ªìng h√†nh s·ª©c kh·ªèe</p>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %} 
                    {% for category, message in messages %}
                        <div style="padding: 10px; border-radius: 12px; margin-bottom: 20px; font-weight: bold; background: #ffe3e3; color: #d63031;">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <div id="login-form" class="step-section active">
                <form action="/login" method="post">
                    <div class="form-group"><input type="text" name="username" placeholder="T√™n ƒëƒÉng nh·∫≠p" required></div>
                    <div class="form-group"><input type="password" name="password" placeholder="M·∫≠t kh·∫©u" required></div>
                    <button type="submit" class="btn btn-primary">ƒêƒÉng Nh·∫≠p <i class="fas fa-arrow-right"></i></button>
                </form>
                <p style="margin-top: 20px; font-size: 14px;">Ch∆∞a c√≥ t√†i kho·∫£n? <span class="toggle-link" onclick="toggleAuth()">ƒêƒÉng k√Ω ngay</span></p>
            </div>
            <div id="register-form" class="step-section" style="display:none;">
                <form action="/register" method="post">
                    <div class="form-group"><input type="text" name="username" placeholder="T√™n ƒëƒÉng nh·∫≠p m·ªõi" required></div>
                    <div class="form-group"><input type="password" name="password" placeholder="M·∫≠t kh·∫©u m·ªõi" required></div>
                    <button type="submit" class="btn btn-primary" style="background: linear-gradient(45deg, #ff6b6b, #ff8e53);">T·∫°o T√†i Kho·∫£n</button>
                </form>
                <p style="margin-top: 20px; font-size: 14px;">ƒê√£ c√≥ t√†i kho·∫£n? <span class="toggle-link" onclick="toggleAuth()">Quay l·∫°i ƒëƒÉng nh·∫≠p</span></p>
            </div>
        </div>
    {% else %}
        <div class="user-info">
            <div class="user-name"><i class="fas fa-user-circle"></i> {{ user.username }} (Ch√†o b·∫°n!)</div>
            <a href="/logout" class="logout-link"><i class="fas fa-sign-out-alt"></i> Tho√°t</a>
        </div>

        {% if not app_data %}
            <div id="step-1" class="step-section active">
                <h2>üìã Thi·∫øt L·∫≠p H·ªì S∆°</h2>
                <form method="post" onsubmit="showLoading()">
                    <input type="hidden" name="setup_full" value="1">
                    <div class="form-group"><label>C√¢n n·∫∑ng (kg)</label><input type="number" step="0.1" name="weight" placeholder="VD: 60" required></div>
                    <div class="form-group"><label>Chi·ªÅu cao (cm)</label><input type="number" name="height" placeholder="VD: 170" required></div>
                    <div class="form-group"><label>Tu·ªïi</label><input type="number" name="age" placeholder="VD: 25" required></div>
                    <div class="form-group"><label>Gi·ªõi t√≠nh</label><select name="gender"><option value="male">Nam</option><option value="female">N·ªØ</option></select></div>
                    <div class="form-group"><label>M·ª•c ti√™u</label><select name="goal"><option value="lose">üìâ Gi·∫£m c√¢n</option><option value="keep">‚öñÔ∏è Gi·ªØ c√¢n</option><option value="gain">üìà TƒÉng c√¢n</option></select></div>
                    <button type="submit" class="btn btn-primary">B·∫Øt ƒê·∫ßu H√†nh Tr√¨nh üöÄ</button>
                </form>
            </div>

        {% elif app_data.current_day > 7 %}
            <div class="step-section active">
                <h2>üìä K·∫øt Qu·∫£ Tu·∫ßn Qua</h2>
                <div class="ai-box"><strong>ü§ñ AI Ph·∫£n h·ªìi:</strong><br>{{ app_data.ai_feedback }}</div>
                <div style="background: #fff; padding: 10px; border-radius: 15px; margin: 20px 0;"><canvas id="caloChart"></canvas></div>
                <form method="post"><input type="hidden" name="restart_option" value="1"><button type="submit" class="btn btn-primary">L√†m m·ªõi l·ªô tr√¨nh üîÑ</button></form>
                <script>new Chart(document.getElementById('caloChart'), { type: 'line', data: { labels: ['N1','N2','N3','N4','N5','N6','N7'], datasets: [{ label: 'Calo ƒê√£ ƒÇn', data: {{ chart_data | tojson }}, borderColor: '#00b09b', tension: 0.4, fill: true, backgroundColor: 'rgba(0, 176, 155, 0.1)' }] } });</script>
            </div>

        {% else %}
            {% if view_mode == 'dashboard' %}
                <div class="step-section active">
                    <h2>üìä Dashboard C·ªßa B·∫°n</h2>
                    
                    <div class="water-card shadow-sm">
                        <h4 style="color: #0077be;"><i class="fas fa-tint"></i> Theo D√µi U·ªëng N∆∞·ªõc</h4>
                        {% set phan_tram = (app_data.water_drank / app_data.water_goal * 100)|round|int %}
                        <div class="progress-container">
                            <div class="progress-bar-water" style="width: {{ phan_tram if phan_tram <= 100 else 100 }}%;"></div>
                        </div>
                        <p style="font-weight: bold;">Ti·∫øn ƒë·ªô: {{ app_data.water_drank }} / {{ app_data.water_goal }} ml ({{ phan_tram }}%)</p>
                        
                        {% if phan_tram < 100 %}
                            <p class="text-muted" style="font-size: 13px; font-style: italic;">"B·∫°n ∆°i, h√£y u·ªëng th√™m n∆∞·ªõc ƒë·ªÉ thanh l·ªçc c∆° th·ªÉ nh√©!"</p>
                        {% else %}
                            <p style="color: #2e7d32; font-size: 13px; font-weight: bold;">‚ú® Ch√∫c m·ª´ng! B·∫°n ƒë√£ ho√†n th√†nh m·ª•c ti√™u n∆∞·ªõc h√¥m nay.</p>
                        {% endif %}

                        <form action="{{ url_for('add_water') }}" method="POST">
                            <button type="submit" name="amount" value="250" class="btn-water">+ 250ml (1 Ly)</button>
                            <button type="submit" name="amount" value="500" class="btn-water">+ 500ml (1 Chai)</button>
                        </form>
                    </div>

                    <h3 style="margin-top: 30px; font-size: 18px;">üìÖ K·∫ø ho·∫°ch 7 ng√†y</h3>
                    <div class="days-grid">
                        {% for i in range(1, 8) %}
                            {% if i < app_data.current_day %}
                                <div class="day-card day-completed"><div class="day-num">Ng√†y {{ i }}</div><div class="day-status"><i class="fas fa-check"></i> Xong</div></div>
                            {% elif i == app_data.current_day %}
                                <a href="{{ url_for('index', day_view=i) }}" class="day-card day-active"><div class="day-num">Ng√†y {{ i }}</div><div class="day-status">ƒêang ch·∫°y <i class="fas fa-play"></i></div></a>
                            {% else %}
                                <div class="day-card day-locked"><div class="day-num">Ng√†y {{ i }}</div><div class="day-status"><i class="fas fa-lock"></i> Kh√≥a</div></div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% elif view_mode == 'detail' %}
                <div class="step-section active">
                    <div style="display:flex; align-items:center; margin-bottom:20px;">
                        <a href="{{ url_for('index') }}" class="btn-back" style="text-decoration:none; color:#333;"><i class="fas fa-arrow-left"></i> Quay l·∫°i</a>
                        <h2 style="flex:1; margin-left: 15px;">Ng√†y {{ request.args.get('day_view') }}</h2>
                    </div>

                    <div class="menu-card">
                        {% set meal_idx = app_data.current_meal %}
                        {% set meal_data = [{'k': 'breakfast', 'l': 'S√°ng'}, {'k': 'lunch', 'l': 'Tr∆∞a'}, {'k': 'dinner', 'l': 'T·ªëi'}] %}
                        {% for i in range(3) %} {% set key = meal_data[i].k %}
                            <div class="meal-row {% if i < meal_idx %}meal-done{% elif i == meal_idx %}meal-active{% endif %}">
                                <span class="meal-label">B·ªØa {{ meal_data[i].l }}:</span>
                                <span class="meal-name">{{ menu_today[key]['name'] }}</span>
                                <span class="meal-cal">{{ menu_today[key]['calo'] }} kcal</span>
                            </div>
                        {% endfor %}
                    </div>

                    <div class="update-box" style="background:#fff; padding:20px; border-radius:20px; margin-top:20px; box-shadow:0 5px 15px rgba(0,0,0,0.05);">
                        <h3>C·∫≠p nh·∫≠t b·ªØa {{ meal_data[meal_idx].l }}</h3>
                        <form method="post" id="updateForm">
                            <input type="hidden" name="update_meal" value="1">
                            <input type="hidden" name="update_type" id="updateType" value="standard">
                            
                            <button type="button" onclick="subStd()" class="btn btn-primary" style="margin-bottom: 15px; width:100%;">Ghi nh·∫≠n: ƒÇn theo th·ª±c ƒë∆°n</button>
                            
                            <p style="font-size: 13px; color: #888; text-align:center;">--- HO·∫∂C ---</p>
                            
                            <div class="form-group">
                                <label>T√™n m√≥n b·∫°n ƒë√£ ƒÉn:</label>
                                <input type="text" name="custom_name" placeholder="VD: B√∫n ri√™u, Ph·ªü b√≤...">
                            </div>
                            <div class="form-group">
                                <label>L∆∞·ª£ng calo (n·∫øu bi·∫øt):</label>
                                <input type="number" name="custom_calo" placeholder="Nh·∫≠p s·ªë calo">
                            </div>
                            <button type="button" onclick="subCus()" class="btn btn-outline-primary" style="width:100%;">L∆∞u m√≥n b·∫°n t·ª± ch·ªçn</button>
                        </form>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    {% endif %}
</div>

<script>
  
    function toggleAuth() { 
        const login = document.getElementById('login-form'); 
        const reg = document.getElementById('register-form'); 
        if(login.style.display === 'none') { 
            login.style.display = 'block'; reg.style.display = 'none'; 
        } else { 
            login.style.display = 'none'; reg.style.display = 'block'; 
        } 
    }
    
  
    function subStd() { 
        document.getElementById('updateType').value='standard'; 
        document.getElementById('updateForm').submit(); 
    }
    

    function subCus() { 
        const name = document.querySelector('input[name="custom_name"]').value;
        if (!name) { 
            alert("B·∫°n ∆°i, h√£y nh·∫≠p t√™n m√≥n ƒÉn ƒë√£ nh√©!"); 
            return; 
        }
        document.getElementById('updateType').value='custom'; 
        document.getElementById('updateForm').submit(); 
    }
    

    function showLoading() { 
        document.getElementById('loading-overlay').style.display = 'flex'; 
    }
</script>
</body>
</html>
