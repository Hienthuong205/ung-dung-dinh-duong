<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Nutrition Coach</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.95); z-index: 9999; justify-content: center; align-items: center; flex-direction: column; text-align: center; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div style="font-size: 60px;">üë©‚Äçüç≥</div>
    <h2 style="color: var(--primary-color);">AI ƒêang So·∫°n Th·ª±c ƒê∆°n...</h2>
    <p>ƒêang t√≠nh to√°n calo v√† ch·ªçn m√≥n ngon cho 7 ng√†y.</p>
    <div class="loader" style="border-color: var(--primary-color); border-bottom-color: transparent; width: 50px; height: 50px;"></div>
</div>

<div class="container">
    {% if not user %}
        <div class="auth-box">
            <div style="font-size: 50px; margin-bottom: 10px;">ü•ë</div>
            <h1 style="color: var(--primary-color);">Health Mate</h1>
            <p style="color: #666; margin-bottom: 30px;">Tr·ª£ l√Ω dinh d∆∞·ª°ng AI</p>
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %} 
                    {% for category, message in messages %}
                        <div style="padding: 10px; border-radius: 12px; margin-bottom: 20px; font-weight: bold; background: #ffe3e3; color: #d63031;">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}
            <div id="login-form" class="step-section active">
                <form action="/login" method="post">
                    <div class="form-group"><input type="text" name="username" placeholder="T√™n ƒëƒÉng nh·∫≠p" required></div>
                    <div class="form-group"><input type="password" name="password" placeholder="M·∫≠t kh·∫©u" required></div>
                    <button type="submit" class="btn btn-primary">ƒêƒÉng Nh·∫≠p <i class="fas fa-arrow-right"></i></button>
                </form>
                <p style="margin-top: 20px; font-size: 14px;">Ch∆∞a c√≥ t√†i kho·∫£n? <span class="toggle-link" onclick="toggleAuth()">ƒêƒÉng k√Ω ngay</span></p>
            </div>
            <div id="register-form" class="step-section">
                <form action="/register" method="post">
                    <div class="form-group"><input type="text" name="username" placeholder="Ch·ªçn t√™n ƒëƒÉng nh·∫≠p" required></div>
                    <div class="form-group"><input type="password" name="password" placeholder="Ch·ªçn m·∫≠t kh·∫©u" required></div>
                    <button type="submit" class="btn btn-primary" style="background: linear-gradient(45deg, #ff6b6b, #ff8e53);">T·∫°o T√†i Kho·∫£n</button>
                </form>
                <p style="margin-top: 20px; font-size: 14px;">ƒê√£ c√≥ t√†i kho·∫£n? <span class="toggle-link" onclick="toggleAuth()">ƒêƒÉng nh·∫≠p</span></p>
            </div>
        </div>
    {% else %}
        <div class="user-info">
            <div class="user-name"><i class="fas fa-user-circle"></i> {{ user.username }}</div>
            <a href="/logout" class="logout-link"><i class="fas fa-sign-out-alt"></i> Tho√°t</a>
        </div>

        {% if not app_data %}
            {% if user.height and user.age %}
                <div id="step-1" class="step-section active">
                    <h2>üëã Ch√†o m·ª´ng tr·ªü l·∫°i!</h2>
                    <form method="post" onsubmit="showLoading()">
                        <input type="hidden" name="setup_quick" value="1">
                        <div class="form-group"><label>C√¢n n·∫∑ng hi·ªán t·∫°i (kg)</label><input type="number" step="0.1" name="weight" placeholder="VD: 60" required></div>
                        <div class="form-group"><label>M·ª•c ti√™u</label><select name="goal"><option value="lose">üìâ Gi·∫£m c√¢n</option><option value="keep">‚öñÔ∏è Gi·ªØ c√¢n</option><option value="gain">üìà TƒÉng c√¢n</option></select></div>
                        <button type="submit" class="btn btn-primary">T·∫°o L·ªô Tr√¨nh M·ªõi üöÄ</button>
                    </form>
                    <div style="text-align:center; margin-top:15px;"><a href="#" onclick="showFullForm()" style="font-size:13px; color:#999;">S·ª≠a h·ªì s∆° g·ªëc?</a></div>
                </div>
                <div id="full-setup-hidden" style="display:none;">
                    <h2>üìã C·∫≠p nh·∫≠t h·ªì s∆°</h2>
                    <form method="post" onsubmit="showLoading()">
                        <input type="hidden" name="setup_full" value="1">
                        <div class="form-group"><label>C√¢n n·∫∑ng</label><input type="number" step="0.1" name="weight" required></div>
                        <div class="form-group"><label>Chi·ªÅu cao</label><input type="number" name="height" value="{{ user.height }}" required></div>
                        <div class="form-group"><label>Tu·ªïi</label><input type="number" name="age" value="{{ user.age }}" required></div>
                        <div class="form-group"><label>Gi·ªõi t√≠nh</label><select name="gender"><option value="male">Nam</option><option value="female">N·ªØ</option></select></div>
                        <div class="form-group"><label>M·ª•c ti√™u</label><select name="goal"><option value="lose">Gi·∫£m</option><option value="keep">Gi·ªØ</option><option value="gain">TƒÉng</option></select></div>
                        <button type="submit" class="btn btn-primary">L∆∞u & T·∫°o Menu</button>
                    </form>
                </div>
            {% else %}
                <div id="step-1" class="step-section active">
                    <h2>üìã Thi·∫øt L·∫≠p H·ªì S∆°</h2>
                    <form method="post" onsubmit="showLoading()">
                        <input type="hidden" name="setup_full" value="1">
                        <div class="form-group"><label>C√¢n n·∫∑ng (kg)</label><input type="number" step="0.1" name="weight" placeholder="VD: 60" required></div>
                        <div class="form-group"><label>Chi·ªÅu cao (cm)</label><input type="number" name="height" placeholder="VD: 170" required></div>
                        <div class="form-group"><label>Tu·ªïi</label><input type="number" name="age" placeholder="VD: 25" required></div>
                        <div class="form-group"><label>Gi·ªõi t√≠nh</label><select name="gender"><option value="male">Nam</option><option value="female">N·ªØ</option></select></div>
                        <div class="form-group"><label>M·ª•c ti√™u</label><select name="goal"><option value="lose">üìâ Gi·∫£m c√¢n</option><option value="keep">‚öñÔ∏è Gi·ªØ c√¢n</option><option value="gain">üìà TƒÉng c√¢n</option></select></div>
                        <button type="submit" class="btn btn-primary">T·∫°o L·ªô Tr√¨nh AI üöÄ</button>
                    </form>
                </div>
            {% endif %}

        {% elif app_data.current_day > 7 %}
            <div class="step-section active">
                {% if app_data.final_weight == 0 %}
                    <h2 style="color: var(--primary-color);">üéâ Ho√†n Th√†nh!</h2>
                    <div style="text-align: center; margin: 30px 0; font-size: 80px;">üèÜ</div>
                    <form method="post"><input type="hidden" name="submit_final_weight" value="1"><div class="form-group"><label>C√¢n n·∫∑ng hi·ªán t·∫°i:</label><input type="number" step="0.1" name="final_weight" required></div><button type="submit" class="btn btn-primary">Xem K·∫øt Qu·∫£</button></form>
                {% else %}
                    <h2>üìä T·ªïng K·∫øt</h2>
                    <div style="display: flex; gap: 10px; margin-bottom: 20px;">
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 15px; flex: 1; text-align: center;"><div style="font-size: 12px;">B·∫Øt ƒë·∫ßu</div><div style="font-size: 18px; font-weight: bold;">{{ app_data.start_weight }} kg</div></div>
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 15px; flex: 1; text-align: center;"><div style="font-size: 12px;">K·∫øt th√∫c</div><div style="font-size: 18px; font-weight: bold;">{{ app_data.final_weight }} kg</div></div>
                    </div>
                    <div class="ai-box"><strong>ü§ñ AI Nh·∫≠n x√©t:</strong><br>{{ app_data.ai_feedback }}</div>
                    <div style="background: #fff; padding: 10px; border-radius: 15px; margin: 20px 0;"><canvas id="caloChart"></canvas></div>
                    <form method="post"><input type="hidden" name="restart_option" value="1"><button type="submit" class="btn btn-primary">V√≤ng m·ªõi üîÑ</button></form>
                    <script>new Chart(document.getElementById('caloChart'), { type: 'line', data: { labels: ['N1','N2','N3','N4','N5','N6','N7'], datasets: [{ label: 'Calo', data: {{ chart_data | tojson }}, borderColor: '#00b09b', tension: 0.4, fill: true, backgroundColor: 'rgba(0, 176, 155, 0.1)' }] }, options: { plugins: { legend: { display: false } } } });</script>
                {% endif %}
            </div>

        {% else %}
            {% if view_mode == 'dashboard' %}
                <div class="step-section active">
                    <h2>üìä Ti·∫øn ƒë·ªô ho√†n th√†nh</h2>
                    <div class="progress-wrapper"><div class="progress-info"><span>Ti·∫øn ƒë·ªô</span><span>{{ ((app_data.current_day - 1) / 7 * 100) | int }}%</span></div><div class="progress-bg"><div class="progress-fill" style="width: {{ ((app_data.current_day - 1) / 7 * 100) }}%;"></div></div></div>
                    {% with messages = get_flashed_messages(with_categories=true) %} 
                        {% if messages %} 
                            {% for category, message in messages %}
                                <div style="padding: 10px; border-radius: 12px; margin-bottom: 15px; text-align: center; font-weight: bold; background: #e8f5e9; color: #2e7d32;">{{ message }}</div>
                            {% endfor %}
                        {% endif %} 
                    {% endwith %}
                    <div class="days-grid">
                        {% for i in range(1, 8) %}
                            {% if i < app_data.current_day %} <div class="day-card day-completed"><div class="day-num">Ng√†y {{ i }}</div><div class="day-status"><i class="fas fa-check"></i> Xong</div></div>
                            {% elif i == app_data.current_day %} <a href="{{ url_for('index', day_view=i) }}" class="day-card day-active"><div class="day-num">Ng√†y {{ i }}</div><div class="day-status">B·∫Øt ƒë·∫ßu <i class="fas fa-play"></i></div></a>
                            {% else %} <div class="day-card day-locked"><div class="day-num">Ng√†y {{ i }}</div><div class="day-status"><i class="fas fa-lock"></i> Kh√≥a</div></div>
                            {% endif %}
                        {% endfor %}
                    </div>
                    <a href="{{ url_for('index', action='reset') }}" style="display:block; text-align:center; margin-top:25px; color:#aaa; font-size:13px; text-decoration: none;">C√†i ƒë·∫∑t l·∫°i</a>
                </div>
            {% elif view_mode == 'detail' %}
                <div class="step-section active">
                    <div style="display:flex; align-items:center; margin-bottom:20px;"><a href="{{ url_for('index') }}" style="background:#f1f3f5; width:40px; height:40px; display:flex; align-items:center; justify-content:center; border-radius:50%; color:#333; text-decoration:none;"><i class="fas fa-arrow-left"></i></a><h2 style="flex:1; margin:0;">Ng√†y {{ request.args.get('day_view') }}</h2></div>
                    {% set meal_idx = app_data.current_meal %}<div class="progress-wrapper"><div class="progress-bg"><div class="progress-fill" style="width: {{ (meal_idx / 3 * 100) }}%;"></div></div></div>
                    <div class="menu-card">
                        {% set meal_data = [{'k': 'breakfast', 'l': 'S√°ng', 'i': 'fa-coffee'}, {'k': 'lunch', 'l': 'Tr∆∞a', 'i': 'fa-utensils'}, {'k': 'dinner', 'l': 'T·ªëi', 'i': 'fa-moon'}] %}
                        {% for i in range(3) %} {% set key = meal_data[i].k %}
                            <div class="meal-row {% if i < meal_idx %}meal-done{% elif i == meal_idx %}meal-active{% endif %}">
                                <div class="meal-icon"><i class="fas {{ meal_data[i].i }}" style="color: {% if i==meal_idx %}var(--primary-color){% else %}#ccc{% endif %};"></i></div>
                                <div class="meal-name">{{ menu_today[key]['name'] }}</div>
                                <div class="meal-cal">{{ menu_today[key]['calo'] }}</div>
                            </div>
                        {% endfor %}
                    </div>
                    <div style="background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.05);">
                        <h3 style="margin-top:0; font-size: 18px;">C·∫≠p nh·∫≠t B·ªØa {{ meal_data[meal_idx].l }}</h3>
                        <form method="post" id="updateForm" enctype="multipart/form-data">
                            <input type="hidden" name="update_meal" value="1"><input type="hidden" name="update_type" id="updateType" value="standard">
                            
                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <button type="button" onclick="subStd()" class="btn btn-finish" style="margin:0;"><i class="fas fa-check"></i> ƒê√∫ng m√≥n</button>
                                <button type="button" onclick="toggleCus()" class="btn btn-custom" style="margin:0;"><i class="fas fa-pen"></i> M√≥n Kh√°c</button>
                            </div>

                            <div id="customBox" class="custom-input-box">
                                <label>T√™n m√≥n:</label><input type="text" name="custom_name" placeholder="VD: B√∫n b√≤...">
                                <label style="margin-top: 15px;">Calo (ƒê·ªÉ tr·ªëng AI s·∫Ω t·ª± t√≠nh):</label><input type="number" name="custom_calo">
                                <button type="button" onclick="subCus()" class="btn btn-primary" style="margin-top:20px; display:flex; justify-content:center; align-items:center;">X·ª≠ L√Ω Ngay <div class="loader" style="display:none"></div></button>
                            </div>
                        </form>
                    </div>
                </div>
            {% endif %}
        {% endif %}
    {% endif %}
</div>

<script>
    function toggleAuth() { const login = document.getElementById('login-form'); const reg = document.getElementById('register-form'); if(login.style.display === 'none') { login.style.display = 'block'; reg.style.display = 'none'; } else { login.style.display = 'none'; reg.style.display = 'block'; } }
    document.getElementById('register-form').style.display = 'none';
    function subStd() { document.getElementById('updateType').value='standard'; document.getElementById('updateForm').submit(); }
    function toggleCus() { var b = document.getElementById('customBox'); b.style.display = (b.style.display==='block')?'none':'block'; }
    function subCus() { document.getElementById('updateType').value='custom'; var btn = document.querySelector('#customBox .btn-primary'); var loader = btn.querySelector('.loader'); btn.innerHTML = 'AI ƒêang T√≠nh... '; btn.appendChild(loader); loader.style.display='inline-block'; btn.style.opacity = '0.7'; document.getElementById('updateForm').submit(); }
    function showFullForm() { document.getElementById('step-1').style.display = 'none'; document.getElementById('full-setup-hidden').style.display = 'block'; }
    function showLoading() { document.getElementById('loading-overlay').style.display = 'flex'; }
</script>
</body>
</html>
